---
title: "COVID-19 - Vaccine efficiency/effectiveness - nomogram"
author: "olivier.duperrex@unisante.ch"
date: "version 2021-09-03"
output:
  html_document:
  df_print: paged
fig_caption: yes
toc: no
editor_options:
  chunk_output_type: console
  markdown: 
    wrap: 72
bibliography: references.bib
---

*TODO : add comments*

# Context

-   In real life public health, we need to understand if the vaccination
    is helping to control the COVID-19, or if we need to investigate
    further.

-   WHO discourages the use of the case-population method ('screening')
    to evaluate the vaccine effectiveness in this context, but states
    that it is appropriate "if there is a need for more rigorous
    investigation".[@who2021] - For details of strength and weakness,
    please refer to Table 1 of the document

-   The ECDC has a very useful ppt. [@ecdc2018]

```{r table_last_imports, echo = FALSE, fig.cap = "WHO. Evaluation of COVID-19 vaccine effectiveness. 2021", out.width = '80%', include = TRUE}

## https://stackoverflow.com/questions/25166624/insert-picture-table-in-r-markdown
knitr::include_graphics(
  here::here('images', 'vaccine_surveillance_WHO_2021_en.png')
  )

```

# Aim

-   Recreate the vaccine efficacy (VE) nomogram from Orenstein 1985
    paper [@orenstein1985]

-   Add some values to quickly check where the current vaccine
    effectiveness is

-   Calculate vaccine effectiveness approximation using the Farrington
    method [@farrington1993]

# Setting up the scene

```{r setup}
knitr::opts_chunk$set(echo = TRUE, collapse = TRUE, comment = NA, include = TRUE, fig.width = 7, fig.height = 7)
# avoid scientific notation
options(scipen=999)


## you are here -----------------------------------------------------
# rm(list = ls())
here::here()

```

## Select language for graph labels

```{r language}


## select the language by comment / uncomment the two lines below
language_chosen <- "en"
# language_chosen <- "fr"

if (language_chosen == 'fr') {
  ## labels fr ---------------------------------
  lab_y <- "PCV attendus = proportion des cas vaccinés attendus"
  lab_x <- "PPV = proportion de la population vaccinée"
  title <-
    "Approximation rapide de l'efficacité vaccinale réelle (VE)"
  subtitle <-
    "Evaluation rapide / cas-population / Orenstein et Farrington"
  lab_VE <- "Efficacité vaccinale"
  label_short <-
    c("Tous", "Moitié", "Un sur 4", "Un sur 10") # known vaccinated cases
  label_annotation_cases_vacc_known <- gt::md(
    "**Hypothèses**  
  Cas vaccinés connus : 1'000  
  Cas totaux : 30'000  
  Si la part connue  
  des cas vaccinés  
  est de ..."
  )
  
} else {
  ## labels en ---------------------------------
  lab_y <- "PCV expected = proportion of cases vaccinated expected"
  lab_x <-  "PPV = proportion of population vaccinated"
  title <- "Rapid assesment of vaccine effectivenes (VE)"
  subtitle <-
    "Screening / case-population / Orenstein and Farrington method"
  lab_VE <- "Vaccine efficacy"
  label_short <-
    c("All", "Half", "One in 4", "One in 10") # known vaccinated cases
  label_annotation_cases_vacc_known <- gt::md(
    "**Hypothesis**  
  Known vaccinated cases: 1'000  
  Total cases: 30'000  
  If the known part  
  of vaccinated cases  
  is ..."
  )
}

```

## The equations

Look at the references for original formulas.


```{r equations}

VE_equation <- "VE = 1 - (PCV / (1 - PCV)) / (PPV / (1 - PPV))"
PCV_equation <- "PCV = (PPV - (PPV * VE)) / (1 - (PPV * VE))"

# caption_table : will be used as caption
caption_table <- VE_equation
```

## Load libraries

```{r load libraries}
pacman::p_load(
  data.table,
  ggplot2,
  ggpmisc,
  ggrepel,
  scales
)
```

## Setup plots and tables

```{r setup plots and tables}
## themes and title for plots ---------------------------------------
theme_set(sjPlot::theme_sjplot2(base_size = 10))
theme_update(
  legend.title = element_blank(),
  legend.position = "right"
)

## Prepare some elements for plots ----------------------------------
# out_png4ppt : output folder for png ---
# needs to be modified according to your own project structure
out_png4ppt <- here::here('output', 'png4ppt') 

```

# Prepare the nomogram

```{r nomogram prep}
## create a list of VE ----------------------------------------------
## selecting only 3 for clarity
VE_list <- c(0.5, 0.85, 0.95)

## create the list for PPV ------------------------------------------
PPV <- seq(0, 1, 0.01)

## create a data.table with combined values -------------------------
dt_1 <- setDT(merge(PPV, VE_list))

## rename columns ---------------------------------------------------
setnames(dt_1, c('x', 'y'), c('PPV', 'VE'))

## calculate the PCV -----------------------------------------------
dt_1[, PCV := (PPV - (PPV * VE)) / (1 - (PPV * VE))]

head(dt_1)
tail(dt_1)
```


```{r p1}
## p1 - plot w nomogram ---------------------------------------------
## saved as p0_VE_nomogram.png
(p1 <- ggplot(dt_1,
              aes(PPV, PCV, group = VE,
                  label = ifelse(PPV == 0.8, percent(VE), ""))) + ## just add label at this value
    geom_line() +
    labs(
      title = title,
      subtitle = subtitle,
      x = lab_x,
      y = lab_y,
      caption = caption_table
    ) +
    scale_x_continuous(n.breaks = 10) +
    scale_y_continuous(n.breaks = 10) +
    ggrepel::geom_text_repel(nudge_y = 0.02) +
    annotate('text', x = 0.77, y = 0.8, label = "VE") +

    theme(plot.subtitle = ggtext::element_markdown())
    )



ggsave("p0_VE_nomogram.png", path = out_png4ppt)
```

# Create some examples

```{r tables}
## example tables  --------------------------------------------------
(t1_PPV50 <-
   dt_1[PPV == 0.5,][, PCV := round(PCV, 2)][, VE := percent(VE)][, one_in := round(1 / PCV)])

(t2_PPV40 <-
    dt_1[PPV == 0.4, ][, PCV := round(PCV, 2)][, VE := percent(VE)][, one_in := round(1 / PCV)])

(t3_PPV80 <-
    dt_1[PPV == 0.8, ][, PCV := round(PCV, 2)][, VE := percent(VE)][, one_in := round(1 / PCV)])

```


## PPV 50%

```{r p1_ppv50}

## p0_1_VE_nomogram_PPV_50.png ------------------------------------------
## create the plot with the reference table for PPV 50%
p1_ppv50 <- p1 + annotate('table', x = 0.2, y = 0.89, label = list(t1_PPV50))
ggsave("p0_1_VE_nomogram_PPV_50_no_data.png", path = out_png4ppt)

## manual update data ----
ppv_all <- 0.485
pcv_all <- 0.023

ve_all <- formattable::percent(1 - (pcv_all / (1 - pcv_all)) / (ppv_all / (1 - ppv_all)), 1)


label_all <-
  gt::md(paste0("PPV : ",
         ppv_all,
         " - PCV : ",
         pcv_all,
         " => VE : ",
         ve_all))



## add points and labels to the plot ----
p1_ppv50_a <- p1_ppv50 +
  geom_point(x = ppv_all,
             y = pcv_all,
             col = 'darkgreen',
             size = 4) +
  annotate(
    'text',
    x = ppv_all,
    y = pcv_all,
    vjust = 1.5,
    col = 'darkgreen',
    label = label_all
  ) 


  
p1_ppv50_a

ggsave("p0_1_VE_nomogram_PPV_50_data_global.png", path = out_png4ppt)
```

### with hypothesis
Persons who are fully vaccinated seem less likely to go for a test even with a few symptoms that are COVID-19 compatible.

```{r p1_ppv50_b}


## add an hypothetical value ----
ppv_all <- 0.5
total_cases_N <- 30000
cases_vacc_N <- 1000


## create a table for hypothesis ----
prop_cases_vacc_tested_hypothetical <- c(1, .5, .25, .1)
# label_short <-  c("All", "Half", "One in 4", "One in 10") # known vaccinated cases

dt_2 <- data.table(prop_cases_vacc_tested_hypothetical, cases_vacc_N, total_cases_N)

dt_2[, cases_vacc_hypothetical_N := cases_vacc_N / prop_cases_vacc_tested_hypothetical]
dt_2[, cases_vacc_missed_N := cases_vacc_hypothetical_N - cases_vacc_N]
dt_2[, total_cases_hypothetical_N := total_cases_N + cases_vacc_missed_N]

dt_2[, pcv_hypothetical := formattable::percent(cases_vacc_hypothetical_N / total_cases_hypothetical_N, 1)]

dt_2[, ve_hypothetical := formattable::percent(1 - (pcv_hypothetical / (1 - pcv_hypothetical)) / (ppv_all / (1 - ppv_all)), 1)][]
dt_2[, VE := ve_hypothetical]
dt_2[, point_color:=fcase(
  VE<.8, '#D55E00',
  VE >=.8 & VE<.9, '#E69F00',
  VE>=.9, '#009E73'
                           )]

dt_2[,label_hypothetical :=
  paste0("PPV : ",
         formattable::percent(ppv_all, 1),
         " - PCV : ",
         pcv_hypothetical,
         " => VE : ",
         ve_hypothetical)]
dt_2[,label_short := label_short][]

name_xlsx <-
  here::here(
    'output',
    'xlsx',
    't_0_1_VE_nomogram_PPV_50_data_global_hypothetical.xlsx'
  )

writexl::write_xlsx(dt_2, name_xlsx)

## add points and labels to the plot ----
p1 +
  # hypothetical points
  geom_point(
    data = dt_2,
    aes(x = ppv_all,
        y = pcv_hypothetical,
        label = label_short),
    col = dt_2$point_color,
    size = 4
  ) +
  ggrepel::geom_text_repel(
    data = dt_2,
    aes(x = ppv_all,
        y = pcv_hypothetical,
        label = label_short),
    nudge_x = -.1
  ) +
  # add a text box to explain
  ggtext::geom_textbox(
    x = 0.4,
    y = 0.7,
    width = grid::unit(0.4, "npc"),
    # 25% of plot panel width
    label = label_annotation_cases_vacc_known
  )

ggsave("p0_1_VE_nomogram_PPV_50_data_global_hypothetical.png", path = out_png4ppt)

## NOTE : the ggtext::geom_textbox() gives a nice output with md format ... but it is very slow!
```

For a vaccination coverage of `r ppv_all`, a number of total cases of `r total_cases_N` and `r cases_vacc_N` vaccinated, this exploration shows that if we know :

* all or half of the cases, the vaccine effectiveness is close the vaccine efficacy 

* only one vaccinated cases in 4, the vaccine effectiveness is lower but acceptable

* only one vaccinated cases in 10, the vaccine effectiveness is much lower and is not acceptable



## PPV 40%

```{r p1_ppv40}
## manual update 
ppv_all <- 0.485
pcv_all <- 0.023



ve_all <- formattable::percent(1 - (pcv_all / (1 - pcv_all)) / (ppv_all / (1 - ppv_all)), 1)

label_all <-
  paste0("PPV : ",
         ppv_all,
         " - PCV : ",
         pcv_all,
         " - VE : ",
         ve_all)

p1 + annotate('table',
              x = 0.2,
              y = 0.89,
              label = list(t2_PPV40)) +
  geom_point(x = ppv_all,
             y = pcv_all,
             col = 'darkgreen',
             size = 4
             ) +
  annotate('text',
    x = ppv_all,
    y = pcv_all,
    hjust = - 0.1,
    col = 'darkgreen',
    label = label_all)

ggsave("p0_2_VE_nomogram_PPV_40.png", path = out_png4ppt)
```

## PPV 80%

```{r p1_ppv80}

ppv_seniors <- 0.785
pcv_seniors <- 0.115

ve_seniors <- formattable::percent(1 - (pcv_seniors / (1 - pcv_seniors)) / (ppv_seniors / (1 - ppv_seniors)), 1)

label_seniors <-
  paste0("PPV : ",
         ppv_seniors,
         " - PCV : ",
         pcv_seniors,
         " - VE : ",
         ve_seniors)

p1 + annotate('table',
              x = 0.2,
              y = 0.89,
              label = list(t3_PPV80)) +
  geom_point(x = ppv_seniors,
             y = pcv_seniors,
             col = 'purple',
             size = 4) +
  annotate('text',
           x = ppv_seniors,
           y = pcv_seniors,
           vjust = 3,
           col = 'purple',
           label = label_seniors)

ggsave("p0_3_VE_nomogram_PPV_80.png", path = out_png4ppt)
```

# References
